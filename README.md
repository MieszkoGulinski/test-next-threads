# Test of Next.js multithreaded build

Next.js uses multiple worker threads to build the project. [While the number of threads is configurable](https://docs.uniform.dev/sitecore/deploy/how-tos/how-to-control-nextjs-threads/), the default is the number of CPU cores.

## The problem

If the build process encounters a very expensive operation, each thread will have to perform this operation. This happened to us when downloading a large amount of data (all articles with their content) from a CMS. As our website design requires a shortened version of each article to be displayed on a list page, we cannot simply download a list of articles and then download the content of each article when building an individual article page. The list, while providing an id, title and lead image, does not provide the content of the article.

To avoid this, we can, for example, download the data before the build process and save it to a file, and then use this file in the build process. Then, when running the application, we can switch to downloading data from the CMS API.

Next.js [provides a way to check if the build process is running](https://github.com/vercel/next.js/discussions/48736):

```ts
import { PHASE_PRODUCTION_BUILD } from "next/constants";

// ...

if (process.env.NEXT_PHASE === PHASE_PRODUCTION_BUILD) {
  // code running during the build process
} else {
  // code running when running the application
}
```

This test checks the behavior of these threads.

## How to run

- To install dependencies, run `npm run install`
- To run the development server, run `npm run dev`
- To build the project, run `npm run build`
- To run the production server, run `npm run start`

## How it works

The project generates a given number of pages with content that consists of the thread "id" generated by running a `Math.random` function in a file `src/data.ts`. This file is imported in the `getStaticProps` function in the `src/pages/[slug].tsx` file. The file `src/data.ts` is executed in the build process in each thread, which results in a different thread id visible in the console and in the page content.

This is a [Next.js](https://nextjs.org/) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).